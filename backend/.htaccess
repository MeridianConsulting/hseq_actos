RewriteEngine On
RewriteBase /backend/

# Archivos/directorios reales pasan directos
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# Marcar solicitudes de evidencias para ajustar headers
RewriteRule ^api/evidencias/ - [E=IS_EVIDENCE:1]

# Enruta /backend/api/... -> /backend/index.php?path=...
RewriteRule ^api/(.*)$ index.php?path=$1 [QSA,L]

# NO configurar headers CORS aqu√≠, ya se hace en PHP

# Endurecimiento de seguridad para backend (API)
<IfModule mod_headers.c>
  Header always set X-Content-Type-Options "nosniff"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), usb=(), payment=()"
  # No aplicar CSP a ninguna respuesta del backend (API no sirve HTML)
  Header always unset Content-Security-Policy
  # X-Frame-Options no es relevante para API ni binarios
  Header always unset X-Frame-Options
  # Evitar doble Cache-Control
  Header merge Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
</IfModule>

# Bloquear acceso directo a archivos sensibles
<FilesMatch "\.(env|sql|ini|log|bak|config|yml|yaml)$">
  Require all denied
</FilesMatch>